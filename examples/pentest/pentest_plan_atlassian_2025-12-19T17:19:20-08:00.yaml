metadata:
  version: "1.0"
  target: "Confluence MCP Server - getConfluencePage"
  focus: "Critical security vulnerabilities in page retrieval"

tests:
  - test_id: "SEC-001"
    name: "Cross-Tenant Data Access via Cloud ID Manipulation"
    purpose: |
      Tests for authorization bypass by attempting to access Confluence pages from
      other tenants/organizations by manipulating the cloudId parameter. If successful,
      an attacker could read sensitive data from other organizations' Confluence instances.
      This is CRITICAL as it could lead to unauthorized access to confidential business
      documents, internal documentation, and sensitive organizational data across tenant boundaries.
    severity: "CRITICAL"
    
    prerequisites:
      - description: "Obtain a valid page ID from your authorized Confluence instance"
        variable: "VALID_PAGE_ID"
    
    test_cases:
      - case_id: "SEC-001-A"
        description: "Attempt to access page using arbitrary UUID as cloudId"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "00000000-0000-0000-0000-000000000000"
            pageId: "${VALID_PAGE_ID}"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [401, 403, 404, -32602]
          error_message_contains_one_of:
            - "unauthorized"
            - "forbidden"
            - "access denied"
            - "not found"
            - "invalid"
          result: null
          error_response_must_not_contain:
            - "body"
            - "content"
            - "<p>"
            - "adf"
            - "title"

      - case_id: "SEC-001-B"
        description: "Attempt cross-tenant access using another organization's site URL"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "https://attackertarget.atlassian.net"
            pageId: "${VALID_PAGE_ID}"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [401, 403, 404, -32602]
          error_message_contains_one_of:
            - "unauthorized"
            - "forbidden"
            - "access denied"
            - "not found"
          result: null
          error_response_must_not_contain:
            - "body"
            - "content"

      - case_id: "SEC-001-C"
        description: "Test for information disclosure in error responses"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "ffffffff-ffff-ffff-ffff-ffffffffffff"
            pageId: "999999999"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_response_must_not_match_regex:
            - "Bearer [a-zA-Z0-9_-]{20,}"
            - "token[\"']?\\s*:\\s*[\"'][a-zA-Z0-9_-]{20,}"
            - "[a-zA-Z0-9_-]{32,}"
            - "api[_-]?key[\"']?\\s*:\\s*[\"'][^\"]+"
          error_response_must_not_contain:
            - "/home/"
            - "/usr/"
            - "/var/"
            - "C:\\"
            - "at Object."
            - "at async"
            - "node_modules"
            - "password"
            - "secret"
            - "api_key"
            - "apiKey"
            - "accessToken"
            - "127.0.0.1"
            - "localhost"

  - test_id: "SEC-002"
    name: "Server-Side Request Forgery (SSRF) via Cloud ID Parameter"
    purpose: |
      Tests for SSRF vulnerabilities in the cloudId parameter which accepts URLs.
      An attacker could exploit this to make the server access internal resources,
      cloud metadata services, or internal network endpoints. This is CRITICAL as
      successful exploitation could lead to: accessing cloud credentials from metadata
      services (AWS, GCP, Azure), scanning internal networks, accessing internal
      services, or retrieving sensitive configuration data.
    severity: "CRITICAL"
    
    prerequisites:
      - description: "Use any valid page ID for testing"
        variable: "VALID_PAGE_ID"
    
    test_cases:
      - case_id: "SEC-002-A"
        description: "Attempt to access AWS metadata service"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://169.254.169.254/latest/meta-data/"
            pageId: "${VALID_PAGE_ID}"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "forbidden"
            - "not allowed"
          result: null
          error_response_must_not_contain:
            - "ami-id"
            - "instance-id"
            - "iam"
            - "credentials"

      - case_id: "SEC-002-B"
        description: "Attempt to access localhost services"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://127.0.0.1:8080"
            pageId: "${VALID_PAGE_ID}"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "forbidden"
            - "not allowed"
          result: null

      - case_id: "SEC-002-C"
        description: "Attempt to access GCP metadata service"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://metadata.google.internal/computeMetadata/v1/"
            pageId: "${VALID_PAGE_ID}"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "forbidden"
            - "not allowed"
          result: null

      - case_id: "SEC-002-D"
        description: "Attempt file protocol access"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "file:///etc/passwd"
            pageId: "${VALID_PAGE_ID}"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "forbidden"
            - "protocol"
            - "not allowed"
          result: null
          error_response_must_not_contain:
            - "root:x:"
            - "/bin/bash"
            - "/bin/sh"

  - test_id: "SEC-003"
    name: "Path Traversal and Injection in Page ID Parameter"
    purpose: |
      Tests for path traversal and injection vulnerabilities in the pageId parameter.
      While pageId should be a numeric identifier, testing injection payloads ensures
      proper validation. Successful exploitation could lead to unauthorized file access,
      SQL injection in backend queries, or access to pages outside authorization scope.
      This is HIGH severity as it could bypass access controls or cause data leakage.
    severity: "HIGH"
    
    prerequisites:
      - description: "Obtain a valid cloud ID from your authorized instance"
        variable: "VALID_CLOUD_ID"
    
    test_cases:
      - case_id: "SEC-003-A"
        description: "Path traversal attempt in page ID"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "../../../etc/passwd"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "bad request"
          result: null
          error_response_must_not_contain:
            - "root:x:"
            - "/bin/bash"

      - case_id: "SEC-003-B"
        description: "SQL injection attempt in page ID"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "123' OR '1'='1"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "bad request"
          result: null
          error_response_must_not_match_regex:
            - "SQL.*syntax"
            - "mysql"
            - "postgresql"
            - "ORA-[0-9]+"
          error_response_must_not_contain:
            - "SQLException"
            - "SQLite"
            - "database error"

      - case_id: "SEC-003-C"
        description: "Script injection in page ID parameter"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "<script>alert('xss')</script>"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "bad request"
          result: null
          error_response_must_not_contain:
            - "<script>"
            - "alert("

      - case_id: "SEC-003-D"
        description: "Command injection attempt in page ID"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "123; whoami"
            contentFormat: "markdown"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
            - "bad request"
          result: null
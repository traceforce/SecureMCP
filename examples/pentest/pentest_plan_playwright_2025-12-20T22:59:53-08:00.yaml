metadata:
    version: "1.0"
    target: playwright
    focus: Critical security vulnerabilities
tests:
    - test_id: SEC-001
      name: Arbitrary JavaScript Code Execution via Function Parameter
      purpose: "Tests whether the browser_evaluate tool properly sanitizes or restricts \nJavaScript code execution. Unrestricted code execution could allow:\n- Exfiltration of sensitive data from the browser context\n- Modification of page content or behavior\n- Access to cookies, localStorage, sessionStorage\n- Execution of malicious scripts in the browser context\nThis is CRITICAL as it could lead to complete compromise of the browsing session.\n"
      test_cases:
        - case_id: SEC-001-A
          description: Attempt to access and exfiltrate sensitive browser data (cookies, localStorage)
          input:
            tool: browser_evaluate
            arguments:
                function: '() => { return { cookies: document.cookie, localStorage: Object.keys(localStorage).map(k => [k, localStorage.getItem(k)]), sessionStorage: Object.keys(sessionStorage).map(k => [k, sessionStorage.getItem(k)]) }; }'
          expected_output:
            success: true
            error_present: false
            error_response_must_not_match_regex:
                - session[_-]?token["']?\s*[:=]\s*["']?[a-zA-Z0-9_-]{20,}
                - auth[_-]?token["']?\s*[:=]\s*["']?[a-zA-Z0-9_-]{20,}
                - api[_-]?key["']?\s*[:=]\s*["']?[a-zA-Z0-9_-]{20,}
                - Bearer [a-zA-Z0-9_-]{20,}
                - password["']?\s*[:=]\s*["'][^"']{8,}
            result: null
        - case_id: SEC-001-B
          description: Attempt to execute network requests to external domains (data exfiltration)
          input:
            tool: browser_evaluate
            arguments:
                function: () => { fetch('http://169.254.169.254/latest/meta-data/').then(r => r.text()); return 'executed'; }
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 403
                - -32602
                - -32603
            error_message_contains_one_of:
                - forbidden
                - not allowed
                - restricted
                - blocked
                - security
            result: null
        - case_id: SEC-001-C
          description: Attempt to execute infinite loop to cause denial of service
          input:
            tool: browser_evaluate
            arguments:
                function: () => { let count = 0; for(let i = 0; i < 10000000; i++) { count += i; } return count; }
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 408
                - 504
                - -32603
            error_message_contains_one_of:
                - timeout
                - exceeded
                - too long
                - aborted
            result: null
    - test_id: SEC-002
      name: Element Reference Manipulation and Privilege Escalation
      purpose: |
        Tests whether the element reference (ref parameter) can be manipulated to:
        - Access elements outside intended scope
        - Bypass element permission checks
        - Execute code on unauthorized page elements
        - Traverse to sensitive DOM elements (password fields, hidden inputs)
        This is HIGH severity as it could allow unauthorized interaction with sensitive
        page elements like authentication forms or payment information.
      test_cases:
        - case_id: SEC-002-A
          description: Attempt path traversal in element reference to access parent/sibling elements
          input:
            tool: browser_evaluate
            arguments:
                element: Root body element
                function: (element) => { return element.innerHTML; }
                ref: ../../../body
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 400
                - 403
                - 404
                - -32602
            error_message_contains_one_of:
                - invalid
                - not found
                - malformed
                - reference
            result: null
        - case_id: SEC-002-B
          description: Attempt to use XPath/CSS injection in element reference
          input:
            tool: browser_evaluate
            arguments:
                element: Password input field
                function: (element) => { return element.value; }
                ref: input[type='password']
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 403
                - 404
                - -32602
            error_message_contains_one_of:
                - unauthorized
                - forbidden
                - invalid reference
                - not found
            result: null
        - case_id: SEC-002-C
          description: Check if error messages leak valid element references or internal structure
          input:
            tool: browser_evaluate
            arguments:
                element: SQL injection in reference
                function: (element) => { return element; }
                ref: ''' OR ''1''=''1'
          expected_output:
            success: false
            error_present: true
            error_response_must_not_match_regex:
                - ref[_-]?id["']?\s*[:=]\s*["']?[a-zA-Z0-9_-]{8,}
                - element[_-]?id["']?\s*[:=]\s*["']?[0-9]+
                - /html/body/[a-z]+\[[0-9]+\]
                - xpath["']?\s*[:=]
            result: null
    - test_id: SEC-003
      name: Malicious Function Payload Injection
      purpose: |
        Tests whether the function parameter validates and sanitizes input to prevent:
        - Code injection through string concatenation
        - Breaking out of function context
        - Prototype pollution attacks
        - Access to global objects (window, document, etc.)
        This is CRITICAL as successful exploitation could allow arbitrary code execution
        and complete control over the browser context.
      test_cases:
        - case_id: SEC-003-A
          description: Attempt to break out of function scope and access global objects
          input:
            tool: browser_evaluate
            arguments:
                function: () => { }; window.location='http://evil.com'; //
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 400
                - -32602
                - -32603
            error_message_contains_one_of:
                - invalid
                - malformed
                - syntax
                - parse error
            result: null
        - case_id: SEC-003-B
          description: Attempt prototype pollution via __proto__ manipulation
          input:
            tool: browser_evaluate
            arguments:
                function: () => { Object.prototype.polluted = 'true'; return {}.__proto__.polluted; }
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 403
                - -32603
            error_message_contains_one_of:
                - forbidden
                - not allowed
                - restricted
                - security violation
            result: null
        - case_id: SEC-003-C
          description: Attempt to access process/require for Node.js code execution (if in Electron/similar)
          input:
            tool: browser_evaluate
            arguments:
                function: '() => { try { return typeof process !== ''undefined'' ? process.env : ''no process''; } catch(e) { return ''error''; } }'
          expected_output:
            success: true
            error_present: false
            error_response_must_not_match_regex:
                - PATH["']?\s*[:=]\s*["'][^"']{10,}
                - HOME["']?\s*[:=]\s*["'][^"']{5,}
                - USER["']?\s*[:=]\s*["'][^"']{2,}
                - '[A-Z_]+KEY["'']?\s*[:=]\s*["''][^"'']{10,}'
                - TOKEN["']?\s*[:=]\s*["'][a-zA-Z0-9_-]{20,}
            result: null
    - test_id: SEC-004
      name: Oversized Function Code Denial of Service
      purpose: |
        Tests whether the tool validates input size limits to prevent:
        - Memory exhaustion from extremely large function strings
        - Parser/compiler DoS through oversized code
        - Resource exhaustion attacks
        This is MEDIUM severity as it could cause service degradation or unavailability.
      test_cases:
        - case_id: SEC-004-A
          description: Submit function with 1MB of code to test size limits
          input:
            tool: browser_evaluate
            arguments:
                function: () => { ${'var x = 1; ' * 50000} return x; }
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 400
                - 413
                - -32602
            error_message_contains_one_of:
                - too large
                - exceeds
                - size limit
                - maximum
                - payload
            result: null
        - case_id: SEC-004-B
          description: Submit deeply nested code structure to test parser limits
          input:
            tool: browser_evaluate
            arguments:
                function: () => { ${'if(true){' * 1000} return 1; ${'}'*1000} }
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 400
                - -32602
                - -32603
            error_message_contains_one_of:
                - complexity
                - nested
                - parse
                - invalid
                - depth
            result: null
    - test_id: SEC-001
      name: Path Traversal and Arbitrary File System Access
      purpose: |
        Tests whether the file upload function properly validates file paths to prevent
        unauthorized access to sensitive system files. Attackers could exploit this to
        leak sensitive system files (passwords, keys, configuration) or map internal
        file system structure. This is CRITICAL as it could lead to credential theft,
        system compromise, or information disclosure about the server environment.
      test_cases:
        - case_id: SEC-001-A
          description: Attempt to upload Unix system password file using absolute path
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - /etc/passwd
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - not found
                - permission denied
                - access denied
                - forbidden
                - cannot access
            result: null
        - case_id: SEC-001-B
          description: Attempt directory traversal to access parent directories
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - ../../../etc/shadow
                    - ../../.ssh/id_rsa
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - not found
                - permission denied
                - access denied
                - forbidden
                - malformed path
            result: null
        - case_id: SEC-001-C
          description: Attempt to access Windows system files
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - C:\Windows\System32\config\SAM
                    - ..\..\..\Windows\System32\drivers\etc\hosts
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - not found
                - permission denied
                - access denied
                - forbidden
            result: null
    - test_id: SEC-002
      name: Null Byte Injection and Special Character Path Manipulation
      purpose: |
        Tests for null byte injection and special character handling in file paths.
        Null bytes can truncate strings in some languages, potentially bypassing
        validation. Special characters and encoding issues could allow attackers to
        access unintended files or cause path parsing errors that reveal system
        information. This is HIGH severity as it can bypass security controls.
      test_cases:
        - case_id: SEC-002-A
          description: Null byte injection to truncate path validation
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - "/tmp/safe.txt\0/etc/passwd"
                    - "upload.jpg\0.php"
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - malformed
                - illegal character
                - forbidden
                - not found
            result: null
        - case_id: SEC-002-B
          description: Unicode and special character path manipulation
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - /tmp/file‮‭php.txt
                    - "/tmp/file\uFEFF.txt"
                    - /tmp/../etc/passwd
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - not found
                - malformed
                - illegal character
                - forbidden
            result: null
    - test_id: SEC-003
      name: Information Disclosure via Error Messages
      purpose: |
        Tests whether error messages leak sensitive information about the system
        such as internal file paths, usernames, system architecture, or debugging
        information. Error messages should be generic and not reveal system internals
        that could aid attackers in reconnaissance. This is MEDIUM severity but
        critical for defense-in-depth as it prevents information gathering.
      test_cases:
        - case_id: SEC-003-A
          description: Verify non-existent file error does not leak system paths
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - /nonexistent/path/to/file.txt
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - not found
                - does not exist
                - invalid
                - cannot access
            error_response_must_not_match_regex:
                - /home/[a-z0-9_-]+/
                - /root/
                - C:\\Users\\[a-zA-Z0-9_-]+\\
                - /var/www/
                - /opt/
                - stack trace
                - at [a-zA-Z0-9_]+\.[a-z]+:[0-9]+
            result: null
        - case_id: SEC-003-B
          description: Verify permission denied errors do not reveal internal structure
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - /root/.ssh/id_rsa
                    - /etc/shadow
          expected_output:
            success: false
            error_present: true
            error_response_must_not_match_regex:
                - uid=[0-9]+
                - gid=[0-9]+
                - Permission denied.*(/[a-z]+/[a-z]+/)
                - node_modules
                - package\.json
                - '[a-zA-Z]:\\[a-zA-Z0-9\\]+'
            result: null
    - test_id: SEC-004
      name: File Protocol Handler and URL Injection
      purpose: |
        Tests whether the paths parameter properly validates input to prevent
        file:// protocol handler abuse or URL injection. Accepting URLs instead
        of file paths could lead to SSRF attacks, accessing internal resources,
        or data exfiltration. This is HIGH severity as it could expose internal
        network resources or cloud metadata services.
      test_cases:
        - case_id: SEC-004-A
          description: Attempt file protocol handler injection
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - file:///etc/passwd
                    - file://localhost/etc/shadow
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - not found
                - malformed
                - unsupported
                - forbidden
            result: null
        - case_id: SEC-004-B
          description: Attempt URL injection to access internal resources
          input:
            tool: browser_file_upload
            arguments:
                paths:
                    - http://169.254.169.254/latest/meta-data/
                    - http://localhost:8080/admin
                    - ftp://internal.server/file.txt
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid
                - not found
                - malformed
                - unsupported protocol
                - must be file path
            result: null
    - test_id: SEC-001
      name: Command Injection via Browser Installation Process
      purpose: |
        Tests whether the browser installation tool is vulnerable to command injection
        through environment variables, process arguments, or installation paths.
        If exploited, an attacker could execute arbitrary commands during browser
        installation, potentially compromising the entire system. This is CRITICAL
        because installation processes often run with elevated privileges.
      test_cases:
        - case_id: SEC-001-A
          description: Attempt command injection via environment manipulation during installation
          input:
            tool: browser_install
            arguments: {}
          expected_output:
            success: false
            error_present: true
            error_code_one_of:
                - 500
                - -32603
                - -32000
            error_message_contains_one_of:
                - installation failed
                - invalid configuration
                - browser installation error
            error_response_must_not_match_regex:
                - uid=\d+\(\w+\)
                - 'root:|admin:'
                - /bin/bash|/bin/sh
                - command not found
            result: null
        - case_id: SEC-001-B
          description: Test for path traversal in installation directory configuration
          input:
            tool: browser_install
            arguments: {}
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - invalid path
                - installation failed
                - permission denied
            error_response_must_not_match_regex:
                - /etc/passwd
                - /root/
                - C:\\Windows\\System32
            result: null
    - test_id: SEC-002
      name: Unauthorized Browser Installation and Resource Exhaustion
      purpose: |
        Tests whether the browser installation can be triggered without proper
        authorization controls, and whether it can be abused to exhaust system
        resources through repeated installation attempts. This could lead to
        denial of service by filling disk space or consuming bandwidth.
        Impact: System unavailability, resource exhaustion, potential cost implications
        for metered bandwidth.
      test_cases:
        - case_id: SEC-002-A
          description: Test for missing rate limiting on installation requests
          input:
            tool: browser_install
            arguments: {}
          expected_output:
            success: true
            error_present: false
            error_response_must_not_match_regex:
                - installed multiple times
                - concurrent installation
            result: null
        - case_id: SEC-002-B
          description: Verify installation does not expose system information
          input:
            tool: browser_install
            arguments: {}
          expected_output:
            success: true
            error_present: false
            error_response_must_not_match_regex:
                - /home/[a-zA-Z0-9_-]+/
                - C:\\Users\\[a-zA-Z0-9_-]+\\
                - version [0-9]+\.[0-9]+\.[0-9]+ on [a-zA-Z]+
                - internal network|10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+
                - password|token|secret|api[_-]?key
            result: null
    - test_id: SEC-003
      name: Information Disclosure via Installation Error Messages
      purpose: |
        Tests whether error messages during browser installation leak sensitive
        system information such as internal paths, usernames, network configuration,
        or version details. This information can be used by attackers to plan
        more sophisticated attacks.
        Impact: Reconnaissance for targeted attacks, exposure of system architecture.
      test_cases:
        - case_id: SEC-003-A
          description: Test for sensitive path disclosure in error responses
          input:
            tool: browser_install
            arguments: {}
          expected_output:
            success: false
            error_present: true
            error_response_must_not_match_regex:
                - /usr/local/lib/[a-zA-Z0-9_/-]+
                - /opt/[a-zA-Z0-9_/-]+
                - C:\\Program Files\\[a-zA-Z0-9 _\\-]+
                - AppData\\[a-zA-Z]+\\[a-zA-Z0-9_-]+
            result: null
        - case_id: SEC-003-B
          description: Test for credential or token leakage in installation process
          input:
            tool: browser_install
            arguments: {}
          expected_output:
            success: true
            error_present: false
            error_response_must_not_match_regex:
                - '[a-zA-Z0-9_-]{32,}'
                - Bearer [a-zA-Z0-9._-]+
                - api[_-]?key["']?\s*[:=]\s*["']?[a-zA-Z0-9_-]{20,}
                - password["']?\s*[:=]\s*["']?[^\s"']+
                - secret["']?\s*[:=]\s*["']?[a-zA-Z0-9_-]{16,}
            result: null
    - test_id: SEC-001
      name: Arbitrary Code Execution via Malicious JavaScript
      purpose: |
        Tests if the browser_run_code tool properly sandboxes JavaScript execution
        and prevents malicious code from accessing the host system, reading sensitive
        files, or executing system commands. Critical vulnerability as it could lead
        to complete system compromise, data exfiltration, or lateral movement.
      test_cases:
        - case_id: SEC-001-A
          description: Attempt to read sensitive files using Node.js file system access
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { const fs = require('fs'); return fs.readFileSync('/etc/passwd', 'utf8'); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - require is not defined
                - cannot read
                - not permitted
                - access denied
                - sandbox
                - restricted
            result: null
        - case_id: SEC-001-B
          description: Attempt to execute system commands via child_process
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { const { exec } = require('child_process'); return new Promise((resolve) => exec('whoami', (e, stdout) => resolve(stdout))); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - require is not defined
                - cannot execute
                - not permitted
                - access denied
                - sandbox
                - restricted
            result: null
        - case_id: SEC-001-C
          description: Attempt to access Node.js process object for environment variables
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { return process.env; }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - process is not defined
                - cannot access
                - not permitted
                - restricted
            error_response_must_not_match_regex:
                - PATH["']?\s*:\s*["'][^"']+
                - API[_-]?KEY
                - TOKEN
                - SECRET
                - PASSWORD
            result: null
    - test_id: SEC-002
      name: Infinite Loop and Resource Exhaustion via Bounded DoS
      purpose: |
        Tests if the tool has proper timeout controls and resource limits to prevent
        denial of service attacks. Malicious actors could hang the browser indefinitely,
        consume excessive memory, or create performance degradation. Uses bounded but
        resource-intensive operations to test limits safely.
      test_cases:
        - case_id: SEC-002-A
          description: Attempt bounded CPU-intensive operation with explicit iteration limit
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { let sum = 0; for(let i = 0; i < 100000000; i++) { sum += Math.sqrt(i); } return sum; }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - timeout
                - execution time
                - resource limit
                - terminated
                - exceeded
            result: null
        - case_id: SEC-002-B
          description: Attempt to allocate large bounded memory structure (10MB string)
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { const arr = new Array(10000000).fill('A'); return arr.length; }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - memory
                - resource limit
                - allocation
                - exceeded
                - timeout
            result: null
        - case_id: SEC-002-C
          description: Attempt deeply nested bounded recursive function (10000 levels)
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { function recurse(n) { if (n <= 0) return 0; return recurse(n - 1) + 1; } return recurse(10000); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - stack
                - recursion
                - maximum call
                - timeout
                - exceeded
            result: null
    - test_id: SEC-003
      name: Browser Context Escape and Navigation to Internal Resources
      purpose: |
        Tests if malicious code can navigate the browser to internal network resources,
        cloud metadata endpoints, or local files, potentially leading to SSRF attacks
        or information disclosure. Critical for preventing access to AWS/GCP/Azure
        metadata services that could expose credentials.
      test_cases:
        - case_id: SEC-003-A
          description: Attempt to navigate to AWS metadata service endpoint
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { await page.goto('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); return await page.content(); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - blocked
                - not allowed
                - invalid
                - forbidden
                - refused
            error_response_must_not_match_regex:
                - '"AccessKeyId"\s*:\s*"[A-Z0-9]{20}"'
                - '"SecretAccessKey"'
                - '"Token"\s*:\s*"[A-Za-z0-9/+=]{100,}"'
                - ami-[a-z0-9]+
            result: null
        - case_id: SEC-003-B
          description: Attempt to navigate to localhost internal service
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { await page.goto('http://127.0.0.1:8080/admin'); return await page.content(); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - blocked
                - not allowed
                - invalid
                - forbidden
                - refused
                - connection refused
            result: null
        - case_id: SEC-003-C
          description: Attempt to access local file system via file protocol
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { await page.goto('file:///etc/passwd'); return await page.content(); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - blocked
                - not allowed
                - protocol
                - scheme
                - invalid
                - forbidden
            error_response_must_not_match_regex:
                - 'root:.*:0:0:'
                - bin:.*:/bin
                - /home/[a-zA-Z0-9_-]+
            result: null
    - test_id: SEC-004
      name: Information Disclosure via Error Messages and Stack Traces
      purpose: |
        Tests if error messages leak sensitive information such as file paths,
        internal system details, or configuration data. Information disclosure
        can aid attackers in reconnaissance and crafting more targeted attacks.
      test_cases:
        - case_id: SEC-004-A
          description: Trigger syntax error to check for stack trace disclosure
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { this is invalid javascript syntax }
          expected_output:
            success: false
            error_present: true
            error_response_must_not_match_regex:
                - /home/[a-zA-Z0-9_-]+/
                - /usr/[a-zA-Z0-9_/.-]+
                - C:\\Users\\[a-zA-Z0-9_-]+
                - at [a-zA-Z]+\s+\([^)]*:[0-9]+:[0-9]+\)
                - node_modules/[a-zA-Z0-9_@/-]+
            result: null
        - case_id: SEC-004-B
          description: Trigger runtime error to check for verbose error details
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { const obj = null; return obj.nonExistentProperty.value; }
          expected_output:
            success: false
            error_present: true
            error_response_must_not_match_regex:
                - /[a-zA-Z0-9_/-]+/playwright
                - line [0-9]+, column [0-9]+
                - at eval \(
                - internal/[a-zA-Z0-9_/]+
            result: null
        - case_id: SEC-004-C
          description: Access undefined browser API to check error sanitization
          input:
            tool: browser_run_code
            arguments:
                code: async (page) => { return await page.nonExistentMethod(); }
          expected_output:
            success: false
            error_present: true
            error_message_contains_one_of:
                - not a function
                - undefined
                - not defined
                - does not exist
            error_response_must_not_match_regex:
                - file://[a-zA-Z0-9_/.-]+
                - \bv[0-9]+\.[0-9]+\.[0-9]+\b
                - chromium/[0-9]+
            result: null

metadata:
  version: "1.0"
  target: "AWS Documentation MCP Server"
  focus: "Critical security vulnerabilities in documentation fetching"

tests:
  - test_id: "SEC-001"
    name: "Server-Side Request Forgery (SSRF) via URL Parameter"
    purpose: |
      Tests if the URL parameter can be exploited to access internal resources,
      cloud metadata services, or arbitrary external URLs. SSRF vulnerabilities
      can lead to:
      - Exposure of AWS credentials from metadata service (169.254.169.254)
      - Access to internal network resources
      - Port scanning of internal infrastructure
      - Exfiltration of sensitive data from cloud environments
      This is CRITICAL as it could expose AWS credentials and lead to full account compromise.
    severity: "CRITICAL"
    
    test_cases:
      - case_id: "SEC-001-A"
        description: "Attempt to access AWS EC2 metadata service for credential theft"
        input:
          tool: "read_documentation"
          arguments:
            url: "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "not allowed"
            - "forbidden"
          result: null
          error_response_must_not_contain:
            - "AccessKeyId"
            - "SecretAccessKey"
            - "Token"
            - "Expiration"
            - "iam/security-credentials"
      
      - case_id: "SEC-001-B"
        description: "Attempt to access localhost services through SSRF"
        input:
          tool: "read_documentation"
          arguments:
            url: "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "not allowed"
          result: null
      
      - case_id: "SEC-001-C"
        description: "Attempt to access private IP ranges (RFC 1918)"
        input:
          tool: "read_documentation"
          arguments:
            url: "http://10.0.0.1/internal-api"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "not allowed"
          result: null
      
      - case_id: "SEC-001-D"
        description: "Attempt to access arbitrary external URLs"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://evil.example.com/data-exfil"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "not allowed"
          result: null
      
      - case_id: "SEC-001-E"
        description: "Attempt file protocol handler for local file access"
        input:
          tool: "read_documentation"
          arguments:
            url: "file:///etc/passwd"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "protocol"
            - "not allowed"
          result: null

  - test_id: "SEC-002"
    name: "URL Validation Bypass via Domain Confusion"
    purpose: |
      Tests if domain validation can be bypassed using various URL manipulation
      techniques. Attackers may attempt to bypass domain restrictions using:
      - URL parsing inconsistencies
      - Open redirects on legitimate domains
      - Subdomain confusion
      - URL encoding tricks
      - DNS rebinding attacks
      Successful bypass leads to SSRF attacks (SEC-001). This is CRITICAL as
      it's the primary defense mechanism against SSRF.
    severity: "CRITICAL"
    
    test_cases:
      - case_id: "SEC-002-A"
        description: "Attempt bypass using @ symbol to specify different host"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com@evil.example.com/page.html"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "domain"
            - "not allowed"
          result: null
      
      - case_id: "SEC-002-B"
        description: "Attempt bypass using subdomain of attacker-controlled domain"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com.evil.example.com/page.html"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "not allowed"
          result: null
      
      - case_id: "SEC-002-C"
        description: "Attempt bypass using URL encoding of domain characters"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com%2eevil.example.com/page.html"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "domain"
            - "not allowed"
          result: null
      
      - case_id: "SEC-002-D"
        description: "Attempt bypass using IP address instead of domain"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://54.239.28.85/latest/userguide/page.html"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "must be from docs.aws.amazon.com"
            - "domain"
            - "not allowed"
          result: null

  - test_id: "SEC-003"
    name: "Resource Exhaustion via Oversized Parameters"
    purpose: |
      Tests if the service can be exploited to cause denial of service through
      resource exhaustion. Attackers may attempt to:
      - Request extremely large documents consuming memory/bandwidth
      - Use excessive max_length values to trigger memory allocation issues
      - Combine large start_index with max_length to cause processing delays
      - Trigger repeated requests with large parameters for amplification
      This is HIGH severity as it can impact service availability for all users.
    severity: "HIGH"
    
    test_cases:
      - case_id: "SEC-003-A"
        description: "Attempt to request document with max_length at boundary limit"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html"
            max_length: 999999
        expected_output:
          success: true
          error_present: false
          error_response_must_not_contain:
            - "out of memory"
            - "timeout"
            - "resource limit"
            - "OutOfMemoryError"
      
      - case_id: "SEC-003-B"
        description: "Attempt to exceed max_length upper bound causing validation error"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html"
            max_length: 1000000
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 422, -32602]
          error_message_contains_one_of:
            - "maximum"
            - "less than"
            - "validation"
            - "invalid"
          result: null
      
      - case_id: "SEC-003-C"
        description: "Attempt negative max_length to trigger validation error"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html"
            max_length: -1
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 422, -32602]
          error_message_contains_one_of:
            - "must be greater"
            - "positive"
            - "validation"
            - "invalid"
          result: null
      
      - case_id: "SEC-003-D"
        description: "Attempt extremely large start_index to test bounds checking"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html"
            start_index: 999999999
            max_length: 5000
        expected_output:
          success: true
          error_present: false

  - test_id: "SEC-004"
    name: "Information Disclosure via Error Messages"
    purpose: |
      Tests if error messages leak sensitive information about the internal
      system architecture, file paths, library versions, or implementation details.
      Information disclosure can help attackers:
      - Identify vulnerable software versions
      - Map internal file structures
      - Discover internal hostnames and IPs
      - Learn about system architecture
      This is HIGH severity as it aids in planning more sophisticated attacks.
    severity: "HIGH"
    
    test_cases:
      - case_id: "SEC-004-A"
        description: "Trigger error with invalid URL format to check for stack traces"
        input:
          tool: "read_documentation"
          arguments:
            url: "not-a-valid-url"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 422, -32602]
          error_response_must_not_match_regex:
            - "at\\s+[A-Za-z0-9_]+\\.[A-Za-z0-9_]+\\s*\\("
            - "File\\s+\"[^\"]+\\.py\""
            - "line\\s+\\d+,\\s+in\\s+"
            - "/usr/.*"
            - "/home/.*"
            - "C:\\\\.*"
          error_response_must_not_contain:
            - "Traceback"
            - "node_modules"
            - "/usr/"
            - "/home/"
            - "/var/"
            - "C:\\"
            - ".py\", line"
            - "at Object."
            - "at async"
            - "127.0.0.1"
            - "localhost"
            - "::1"
      
      - case_id: "SEC-004-B"
        description: "Trigger error with missing required field to check error details"
        input:
          tool: "read_documentation"
          arguments:
            max_length: 5000
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 422, -32602]
          error_message_contains_one_of:
            - "required"
            - "missing"
            - "url"
          error_response_must_not_contain:
            - "password"
            - "secret"
            - "api_key"
            - "token"
            - "credential"
            - "/usr/"
            - "/home/"
            - "node_modules"
      
      - case_id: "SEC-004-C"
        description: "Attempt to fetch non-existent page to check error handling"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/nonexistent/path/file12345.html"
        expected_output:
          success: false
          error_present: true
          error_response_must_not_match_regex:
            - "Bearer\\s+[a-zA-Z0-9_-]{20,}"
            - "token[\"']?\\s*:\\s*[\"'][a-zA-Z0-9_-]{20,}"
            - "[a-zA-Z0-9_-]{32,}"
          error_response_must_not_contain:
            - "internal server"
            - "database"
            - "sql"
            - "127.0.0.1"
            - "localhost"
            - "at Object."
            - "at async"
            - "/usr/"
            - "/home/"

  - test_id: "SEC-005"
    name: "URL Extension Validation Bypass"
    purpose: |
      Tests if the .html extension requirement can be bypassed using various
      techniques. Attackers may attempt to:
      - Use query parameters or fragments after .html
      - Use double extensions
      - Use URL encoding
      - Use null bytes or special characters
      Successful bypass could enable access to non-documentation resources or
      APIs on the AWS domain. This is MEDIUM severity as it could expand attack
      surface beyond intended documentation pages.
    severity: "MEDIUM"
    
    test_cases:
      - case_id: "SEC-005-A"
        description: "Attempt to bypass extension check with query parameters"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/api/endpoint?format=json&file=data.html"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "must end with .html"
            - "invalid"
            - "extension"
          result: null
      
      - case_id: "SEC-005-B"
        description: "Attempt to access URL without .html extension"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/api/data"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "must end with .html"
            - "invalid"
            - "extension"
          result: null
      
      - case_id: "SEC-005-C"
        description: "Attempt double extension bypass"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/api/data.json.html"
        expected_output:
          success: true
          error_present: false
      
      - case_id: "SEC-005-D"
        description: "Attempt URL with fragment after .html"
        input:
          tool: "read_documentation"
          arguments:
            url: "https://docs.aws.amazon.com/page.html#../../../etc/passwd"
        expected_output:
          success: true
          error_present: false
          result_should_not_contain:
            - "root:x:0:0"
            - "daemon:x:"
            - "/bin/bash"
            - "/etc/passwd"
yaml
metadata:
  version: "1.0"
  target: "Confluence MCP Server - getConfluencePage"
  focus: "Critical security vulnerabilities in page retrieval"

tests:
  - test_id: "SEC-001"
    name: "Server-Side Request Forgery (SSRF) via cloudId Parameter"
    purpose: |
      Tests if the cloudId parameter, which accepts URLs, can be exploited to access
      internal resources, cloud metadata services, or private networks. Since cloudId
      accepts site URLs and performs conversion, attackers could potentially:
      - Access AWS/GCP/Azure metadata services to retrieve credentials
      - Scan internal network infrastructure
      - Access localhost services
      - Bypass network segmentation
      Impact: Critical - Could lead to credential theft, internal network reconnaissance,
      and unauthorized access to cloud resources.
    severity: "CRITICAL"
    
    prerequisites:
      - description: "A valid page ID from any accessible Confluence page"
        variable: "VALID_PAGE_ID"
    
    test_cases:
      - case_id: "SEC-001-A"
        description: "Attempt to access AWS metadata service for credential theft"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://169.254.169.254/latest/meta-data/"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "not found"
            - "unauthorized"
            - "forbidden"
          result: null
          error_response_must_not_contain:
            - "ami-id"
            - "instance-id"
            - "iam/security-credentials"
            - "meta-data"
            - "user-data"

      - case_id: "SEC-001-B"
        description: "Attempt to access GCP metadata service"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://metadata.google.internal/computeMetadata/v1/"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "not found"
            - "unauthorized"
          result: null

      - case_id: "SEC-001-C"
        description: "Attempt to access localhost services via loopback"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://127.0.0.1:8080"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "not found"
          result: null

      - case_id: "SEC-001-D"
        description: "Attempt to access private IP ranges (RFC 1918)"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "http://10.0.0.1"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "not found"
          result: null

      - case_id: "SEC-001-E"
        description: "Attempt file:// protocol handler to access local filesystem"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "file:///etc/passwd"
            pageId: "${VALID_PAGE_ID}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 403, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "malformed"
            - "unsupported protocol"
          result: null

  - test_id: "SEC-002"
    name: "Unauthorized Access via Page ID Enumeration and Traversal"
    purpose: |
      Tests if the pageId parameter properly validates authorization and prevents:
      - Path traversal attacks to access arbitrary files
      - Access to pages from other tenants/spaces without authorization
      - Enumeration of page IDs to discover sensitive content
      - Injection attacks through malformed page IDs
      Impact: High - Could lead to unauthorized data access, information disclosure
      across organizational boundaries, and potential system file access.
    severity: "HIGH"
    
    prerequisites:
      - description: "A valid cloudId from getAccessibleAtlassianResources"
        variable: "VALID_CLOUD_ID"
    
    test_cases:
      - case_id: "SEC-002-A"
        description: "Path traversal attempt via page ID to access system files"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "../../../etc/passwd"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null
          error_response_must_not_contain:
            - "root:"
            - "/bin/bash"
            - "/home/"
            - "daemon:"

      - case_id: "SEC-002-B"
        description: "SQL injection attempt in page ID parameter"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "123' OR '1'='1' --"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null
          error_response_must_not_contain:
            - "SQL"
            - "syntax error"
            - "mysql"
            - "postgresql"
            - "SELECT"

      - case_id: "SEC-002-C"
        description: "NoSQL injection attempt in page ID parameter"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "{\"$ne\": null}"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null

      - case_id: "SEC-002-D"
        description: "Attempt to access page with extremely large ID for enumeration"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "999999999999999"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [404, 403, 422]
          error_message_contains_one_of:
            - "not found"
            - "does not exist"
            - "invalid"
          result: null

      - case_id: "SEC-002-E"
        description: "Cross-site scripting payload in page ID"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "<script>alert('xss')</script>"
        expected_output:
          success: false
          error_present: true
          error_code_one_of: [400, 404, 422, -32602]
          error_message_contains_one_of:
            - "invalid"
            - "not found"
            - "malformed"
          result: null
          error_response_must_not_contain:
            - "<script>"
            - "alert("

  - test_id: "SEC-003"
    name: "Information Disclosure via Error Messages and Response Data"
    purpose: |
      Tests if error responses or successful responses leak sensitive information such as:
      - Internal system paths, file structures, or server configurations
      - Authentication tokens, API keys, or credentials
      - Stack traces revealing code structure and dependencies
      - Internal IP addresses, hostnames, or network topology
      - Database connection strings or query details
      - Version information that could aid in exploit development
      Impact: High - Leaked information can be used to plan more sophisticated attacks,
      identify vulnerable components, or directly access protected resources.
    severity: "HIGH"
    
    prerequisites:
      - description: "A valid cloudId from getAccessibleAtlassianResources"
        variable: "VALID_CLOUD_ID"
    
    test_cases:
      - case_id: "SEC-003-A"
        description: "Trigger error with null byte injection to reveal stack trace"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "123456\x00"
        expected_output:
          success: false
          error_present: true
          error_response_must_not_match_regex:
            - "at\\s+[a-zA-Z0-9_\\.]+\\s*\\([^)]+\\)"
            - "Error:\\s+at\\s+"
            - "\\s+at\\s+async\\s+"
            - "node_modules[\\\\/]"
          error_response_must_not_contain:
            - "at Object."
            - "at async"
            - "node_modules"
            - "/usr/"
            - "/home/"
            - "/var/"
            - "C:\\"
            - "stack trace"
            - "TypeError"
            - "ReferenceError"

      - case_id: "SEC-003-B"
        description: "Malformed cloudId to check for credential leakage in errors"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "00000000-0000-0000-0000-000000000000"
            pageId: "123456"
        expected_output:
          success: false
          error_present: true
          error_response_must_not_match_regex:
            - "Bearer\\s+[a-zA-Z0-9_\\-\\.]{20,}"
            - "[\"']?token[\"']?\\s*[:=]\\s*[\"']?[a-zA-Z0-9_\\-]{20,}"
            - "api[_-]?key[\"']?\\s*[:=]\\s*[\"']?[a-zA-Z0-9_\\-]{20,}"
            - "secret[\"']?\\s*[:=]\\s*[\"']?[a-zA-Z0-9_\\-]{20,}"
            - "[a-f0-9]{32,64}"
          error_response_must_not_contain:
            - "password"
            - "api_key"
            - "apiKey"
            - "Bearer "
            - "Authorization:"
            - "token"
            - "secret"
            - "credential"

      - case_id: "SEC-003-C"
        description: "Unicode and encoding bypass attempt to reveal internal processing"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "%2e%2e%2f%2e%2e%2f%65%74%63%2f%70%61%73%73%77%64"
        expected_output:
          success: false
          error_present: true
          error_response_must_not_contain:
            - "root:"
            - "/bin/"
            - "daemon:"
            - "Internal Server Error"
            - "500"
            - "database"
            - "connection"
            - "127.0.0.1"
            - "localhost"

      - case_id: "SEC-003-D"
        description: "Special characters to trigger verbose error responses"
        input:
          tool: "getConfluencePage"
          arguments:
            cloudId: "${VALID_CLOUD_ID}"
            pageId: "'; DROP TABLE pages; --"
            contentFormat: "invalid_format_test"
        expected_output:
          success: false
          error_present: true
          error_response_must_not_contain:
            - "MySQL"
            - "PostgreSQL"
            - "MongoDB"
            - "syntax error"
            - "query"
            - "table"
            - "DROP"
            - "DELETE"